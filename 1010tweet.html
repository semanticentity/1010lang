<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>$1010 Tweet Player</title>
  <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@400;500;600&family=IBM+Plex+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; }
    body {
      background: #0a0a0f;
      color: #ccc;
      font-family: 'IBM Plex Sans', -apple-system, sans-serif;
      font-size: 14px;
      padding: 24px;
      max-width: 540px;
      margin: 0 auto;
    }
    h1 {
      color: #9bbc0f;
      margin: 0 0 6px 0;
      font-size: 28px;
      font-weight: 600;
      font-family: 'IBM Plex Mono', monospace;
    }
    .sub { color: #888; font-size: 14px; margin-bottom: 24px; }

    .editor-wrap {
      display: flex;
      gap: 0;
    }
    .labels {
      display: flex;
      flex-direction: column;
      padding: 10px 0;
      background: #0a0a0a;
      border: 1px solid #333;
      border-right: none;
      border-radius: 4px 0 0 4px;
    }
    .label {
      height: 22px;
      line-height: 22px;
      padding: 0 12px;
      font-size: 11px;
      color: #666;
      text-align: right;
      text-transform: uppercase;
      font-family: 'IBM Plex Sans', sans-serif;
      font-weight: 500;
      letter-spacing: 0.5px;
    }
    textarea {
      flex: 1;
      height: 154px;
      background: #111;
      color: #9bbc0f;
      border: 1px solid #333;
      padding: 10px 12px;
      font-family: 'IBM Plex Mono', monospace;
      font-size: 14px;
      line-height: 22px;
      resize: none;
      overflow: hidden;
      border-radius: 0 4px 4px 0;
    }
    textarea:focus { outline: 2px solid #9bbc0f; outline-offset: -1px; }

    .controls {
      display: flex;
      gap: 12px;
      margin: 20px 0;
    }
    button {
      background: linear-gradient(180deg, #2a2a2a 0%, #1a1a1a 100%);
      color: #9bbc0f;
      border: 1px solid #444;
      padding: 12px 20px;
      font-family: 'IBM Plex Sans', sans-serif;
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 1px;
      cursor: pointer;
      flex: 1;
      border-radius: 4px;
      transition: all 0.15s ease;
    }
    button:hover { background: #333; border-color: #555; }
    button:active { background: #1a1a1a; }
    button.play { border-color: #9bbc0f; }

    .steps {
      display: flex;
      gap: 4px;
      margin: 20px 0;
    }
    .step {
      width: 28px;
      height: 28px;
      background: #111;
      border: 1px solid #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-family: 'IBM Plex Mono', monospace;
      color: #444;
      border-radius: 3px;
    }
    .step.current { background: #9bbc0f; color: #0f380f; font-weight: 600; }
    .step.active { border-color: #9bbc0f; }

    .status {
      color: #888;
      font-size: 13px;
      min-height: 24px;
    }
    .status.error { color: #f66; }
    .status.ok { color: #9bbc0f; }

    .examples {
      margin-top: 32px;
      padding-top: 24px;
      border-top: 1px solid #222;
    }
    .examples h3 {
      color: #666;
      font-size: 12px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 1px;
      margin: 0 0 12px 0;
    }
    .example {
      background: #0f0f0f;
      padding: 10px 14px;
      margin: 6px 0;
      font-size: 13px;
      color: #888;
      cursor: pointer;
      border: 1px solid transparent;
      border-radius: 4px;
      transition: all 0.15s ease;
    }
    .example:hover { border-color: #333; color: #aaa; background: #141414; }
    .example-name { color: #9bbc0f; font-weight: 600; }

    .byte-count {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #555;
      margin-top: 8px;
      font-family: 'IBM Plex Mono', monospace;
    }
    .key {
      font-size: 10px;
      color: #444;
      letter-spacing: 0.3px;
      font-family: 'IBM Plex Mono', monospace;
    }
    .hint {
      font-size: 12px;
      color: #555;
      margin-top: 10px;
    }
    .hint a { color: #777; text-decoration: none; }
    .hint a:hover { color: #9bbc0f; }
  </style>
</head>
<body>
  <h1>$1010</h1>
  <p class="sub">paste a song. hit play. 280 bytes max.</p>

  <div class="editor-wrap">
    <div class="labels" id="labels"></div>
    <textarea id="input" spellcheck="false" placeholder="BPM:122
1000:x...x...x...x...
1020:....x.......x...
1100:39..3C..40..39..
1200:21......21..24..
1300:................"></textarea>
  </div>
  <div class="byte-count">
    <span id="bytes">0</span>/280 bytes
    <span class="key">1000:kick 1020:snare 1100:lead 1200:bass 1300:noise</span>
  </div>

  <div class="controls">
    <button class="play" id="btn-play">PLAY</button>
    <button id="btn-stop">STOP</button>
    <button id="btn-copy" title="Copy to clipboard">COPY</button>
  </div>
  <div class="hint">paste into <a href="1010sequencer.html" target="_blank">full sequencer</a> â†’ LOAD</div>

  <div class="steps" id="steps"></div>
  <div class="status" id="status"></div>

  <div class="examples">
    <h3>examples (click to load)</h3>
    <div class="example" data-song="BPM:122
1000:x...x...x...x...
1020:....x.......x...
1100:39..3C..40..39..
1200:21......21..24..">
      <span class="example-name">house</span> - deep / kerri chandler
    </div>
    <div class="example" data-song="BPM:100
1000:x.....x.x.......
1020:....x.......x...
1100:40....43..45....
1200:28..28....2B....
1300:.x.x.x.x.x.x.x.x">
      <span class="example-name">hiphop</span> - boom bap
    </div>
    <div class="example" data-song="BPM:140
1000:x...x...x...x...
1020:..x.x.......x..x
1300:xxxx..xxx..xxxxx">
      <span class="example-name">techno</span> - minimal
    </div>
    <div class="example" data-song="BPM:85
1000:x.....x...x.....
1020:....x.......x..x
1100:3C....3C..3E....
1200:18......1D......">
      <span class="example-name">lofi</span> - chill
    </div>
  </div>

  <script>
    // Memory
    const mem = new Uint8Array(65536);
    let currentStep = 0;
    let isPlaying = false;
    let timer = null;
    let bpm = 120;
    let audioCtx = null;

    // Address map
    const ADDR = {
      '1000': 0x1000, // kick gate
      '1010': 0x1010, // kick pitch
      '1020': 0x1020, // snare gate
      '1100': 0x1100, // lead gate
      '1200': 0x1200, // bass gate
      '1300': 0x1300, // noise gate
    };

    // Build step display
    const stepsEl = document.getElementById('steps');
    for (let i = 0; i < 16; i++) {
      const s = document.createElement('div');
      s.className = 'step';
      s.textContent = i.toString(16).toUpperCase();
      s.id = `s${i}`;
      stepsEl.appendChild(s);
    }

    // Parse mini format
    function parse(text) {
      mem.fill(0, 0x1000, 0x1400);
      bpm = 120;
      const lines = text.trim().split('\n');

      for (const line of lines) {
        const l = line.trim();
        if (!l || l.startsWith('#') || l.startsWith(';')) continue;

        // BPM:120
        if (l.toUpperCase().startsWith('BPM:')) {
          bpm = parseInt(l.slice(4)) || 120;
          bpm = Math.max(40, Math.min(200, bpm));
          continue;
        }

        // 1000:x...x...
        const match = l.match(/^([0-9A-Fa-f]{4}):(.+)$/);
        if (match) {
          const addr = parseInt(match[1], 16);
          const data = match[2];
          parsePattern(addr, data);
        }
      }

      return true;
    }

    function parsePattern(addr, data) {
      // Remove spaces
      data = data.replace(/\s/g, '');

      for (let i = 0; i < 16 && i < data.length; i++) {
        const ch = data[i];
        let val = 0;

        if (ch === 'x' || ch === 'X') {
          val = 1;
        } else if (ch === '.') {
          val = 0;
        } else if (/[0-9A-Fa-f]/.test(ch)) {
          // Hex pair
          if (i + 1 < data.length && /[0-9A-Fa-f]/.test(data[i + 1])) {
            val = parseInt(data[i] + data[i + 1], 16);
            // Skip next char since we consumed it
            mem[addr + Math.floor(i / 2)] = val;
            i++;
            continue;
          } else {
            val = parseInt(ch, 16);
          }
        }

        mem[addr + i] = val;
      }
    }

    // Audio
    function getCtx() {
      if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      if (audioCtx.state === 'suspended') audioCtx.resume();
      return audioCtx;
    }

    function mtof(n) { return 440 * Math.pow(2, (n - 69) / 12); }

    function playKick() {
      const ctx = getCtx(), now = ctx.currentTime;
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type = 'sine';
      o.frequency.setValueAtTime(150, now);
      o.frequency.exponentialRampToValueAtTime(40, now + 0.1);
      g.gain.setValueAtTime(0.7, now);
      g.gain.exponentialRampToValueAtTime(0.01, now + 0.3);
      o.connect(g).connect(ctx.destination);
      o.start(now); o.stop(now + 0.3);
    }

    function playSnare() {
      const ctx = getCtx(), now = ctx.currentTime;
      const buf = ctx.createBuffer(1, ctx.sampleRate * 0.1, ctx.sampleRate);
      const d = buf.getChannelData(0);
      for (let i = 0; i < d.length; i++) d[i] = Math.random() * 2 - 1;
      const n = ctx.createBufferSource(); n.buffer = buf;
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.3, now);
      g.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
      n.connect(g).connect(ctx.destination);
      n.start(now); n.stop(now + 0.15);
    }

    function playLead(note) {
      if (!note) return;
      const ctx = getCtx(), now = ctx.currentTime;
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type = 'square';
      o.frequency.value = mtof(note);
      g.gain.setValueAtTime(0.12, now);
      g.gain.exponentialRampToValueAtTime(0.01, now + 0.15);
      o.connect(g).connect(ctx.destination);
      o.start(now); o.stop(now + 0.2);
    }

    function playBass(note) {
      if (!note) return;
      const ctx = getCtx(), now = ctx.currentTime;
      const o = ctx.createOscillator(), g = ctx.createGain();
      o.type = 'sawtooth';
      o.frequency.value = mtof(note);
      g.gain.setValueAtTime(0.3, now);
      g.gain.exponentialRampToValueAtTime(0.01, now + 0.25);
      o.connect(g).connect(ctx.destination);
      o.start(now); o.stop(now + 0.3);
    }

    function playNoise() {
      const ctx = getCtx(), now = ctx.currentTime;
      const buf = ctx.createBuffer(1, ctx.sampleRate * 0.05, ctx.sampleRate);
      const d = buf.getChannelData(0);
      for (let i = 0; i < d.length; i++) d[i] = Math.random() * 2 - 1;
      const n = ctx.createBufferSource(); n.buffer = buf;
      const f = ctx.createBiquadFilter(); f.type = 'highpass'; f.frequency.value = 8000;
      const g = ctx.createGain();
      g.gain.setValueAtTime(0.15, now);
      g.gain.exponentialRampToValueAtTime(0.01, now + 0.05);
      n.connect(f).connect(g).connect(ctx.destination);
      n.start(now); n.stop(now + 0.08);
    }

    // Tick
    function tick() {
      // Trigger voices
      if (mem[0x1000 + currentStep]) playKick();
      if (mem[0x1020 + currentStep]) playSnare();
      if (mem[0x1100 + currentStep]) playLead(mem[0x1100 + currentStep]);
      if (mem[0x1200 + currentStep]) playBass(mem[0x1200 + currentStep]);
      if (mem[0x1300 + currentStep]) playNoise();

      // Update display
      for (let i = 0; i < 16; i++) {
        const el = document.getElementById(`s${i}`);
        el.classList.toggle('current', i === currentStep);
        const active = mem[0x1000+i] || mem[0x1020+i] || mem[0x1100+i] || mem[0x1200+i] || mem[0x1300+i];
        el.classList.toggle('active', active > 0);
      }

      currentStep = (currentStep + 1) & 15;
    }

    function start() {
      if (isPlaying) return;

      const input = document.getElementById('input').value;
      try {
        parse(input);
        setStatus(`Playing @ ${bpm} BPM (edits apply next loop)`, 'ok');
      } catch (e) {
        setStatus('Parse error: ' + e.message, 'error');
        return;
      }

      isPlaying = true;
      currentStep = 0;

      const loop = () => {
        if (!isPlaying) return;

        // Hot reload: re-parse on step 0 (start of loop)
        if (currentStep === 0) {
          try {
            const newInput = document.getElementById('input').value;
            const oldBpm = bpm;
            parse(newInput);
            if (bpm !== oldBpm) {
              setStatus(`Playing @ ${bpm} BPM (tempo changed!)`, 'ok');
            }
          } catch (e) {
            // Keep playing with old pattern if parse fails
          }
        }

        tick();
        const ms = (60 / bpm / 4) * 1000;
        timer = setTimeout(loop, ms);
      };
      loop();
    }

    function stop() {
      isPlaying = false;
      if (timer) clearTimeout(timer);
      setStatus('Stopped', '');
      for (let i = 0; i < 16; i++) {
        document.getElementById(`s${i}`).classList.remove('current');
      }
    }

    function setStatus(msg, type) {
      const el = document.getElementById('status');
      el.textContent = msg;
      el.className = 'status ' + (type || '');
    }

    // Address to label map
    const ADDR_LABELS = {
      'BPM': 'bpm',
      '1000': 'kick',
      '1020': 'snare',
      '1100': 'lead',
      '1200': 'bass',
      '1300': 'noise'
    };

    // Update labels based on content
    function updateLabels() {
      const text = document.getElementById('input').value;
      const lines = text.split('\n');
      const labelsEl = document.getElementById('labels');
      labelsEl.innerHTML = '';

      lines.forEach(line => {
        const l = line.trim();
        let label = '';

        if (l.toUpperCase().startsWith('BPM:')) {
          label = 'bpm';
        } else {
          const match = l.match(/^([0-9A-Fa-f]{4}):/);
          if (match) {
            label = ADDR_LABELS[match[1].toUpperCase()] || match[1];
          }
        }

        const div = document.createElement('div');
        div.className = 'label';
        div.textContent = label;
        labelsEl.appendChild(div);
      });
    }

    // Byte counter + labels
    document.getElementById('input').addEventListener('input', (e) => {
      const len = new TextEncoder().encode(e.target.value).length;
      document.getElementById('bytes').textContent = len;
      document.getElementById('bytes').style.color = len > 280 ? '#f44' : '#444';
      updateLabels();
    });

    // Controls
    document.getElementById('btn-play').onclick = start;
    document.getElementById('btn-stop').onclick = stop;
    document.getElementById('btn-copy').onclick = () => {
      const text = document.getElementById('input').value;
      navigator.clipboard.writeText(text).then(() => {
        setStatus('Copied! Paste into sequencer.', 'ok');
      });
    };

    // Examples
    let currentExample = null;
    document.querySelectorAll('.example').forEach(el => {
      el.onclick = () => {
        const song = el.dataset.song;
        document.getElementById('input').value = song;
        document.getElementById('input').dispatchEvent(new Event('input'));

        // If same example and playing, reset to step 0
        // If different example or not playing, start fresh
        if (currentExample === el && isPlaying) {
          currentStep = 0;
        } else {
          stop();
          currentExample = el;
          start();
        }

        // Highlight active example
        document.querySelectorAll('.example').forEach(e => e.style.borderColor = 'transparent');
        el.style.borderColor = '#9bbc0f';
      };
    });

    // Load first example (don't auto-play)
    document.querySelector('.example').click();
    stop();
    updateLabels();
  </script>
</body>
</html>
